<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Apartment Booking</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.4/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.4/main.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 10px; }
    #calendar { max-width: 900px; margin: auto; }
    #confirm { margin-top: 10px; display: block; width: 100%; padding: 10px; font-size: 16px; }
  </style>
</head>
<body>

<h2>Book Apartment</h2>
<label>Apartment ID: <input type="text" id="a_id" value="apt001"></label>
<div id="calendar"></div>
<button id="confirm">Book Selected Dates</button>

<script>
const scriptURL = 'https://script.google.com/macros/s/AKfycbxNeoew4ijkCI7jP9RFGNmwWKEUJxI5N8GmT0qkHJ9503pT-lv10KuCPTRoHj8Wu8ix/exec';
let selectedDates = [];

document.addEventListener('DOMContentLoaded', function () {
  const calendarEl = document.getElementById('calendar');

  let calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    selectable: true,
    selectOverlap: false,
    selectAllow: info => !info.startStr.includes('past'),
    validRange: { start: new Date().toISOString().split("T")[0] },

    select: function (info) {
      selectedDates = [info.startStr, info.endStr];
      alert(`Selected: ${info.startStr} to ${info.endStr}`);
    },

    events: async function (fetchInfo, successCallback) {
      const a_id = document.getElementById("a_id").value;
      let res = await fetch(`${scriptURL}?a_id=${a_id}`);
      let booked = await res.json();
      let events = booked.map(date => ({
        title: "Booked",
        start: date,
        color: "red",
        display: "background"
      }));
      successCallback(events);
    }
  });

  calendar.render();

  document.getElementById("confirm").addEventListener("click", async () => {
    if (!selectedDates.length) {
      alert("Please select a date range");
      return;
    }

    const a_id = document.getElementById("a_id").value;
    const payload = {
      a_id: a_id,
      start: selectedDates[0],
      end: selectedDates[1],
    };

    const res = await fetch(scriptURL, {
      method: "POST",
      body: JSON.stringify(payload),
      headers: { "Content-Type": "application/json" },
    });

    alert("Booking saved!");
    location.reload();
  });
});
</script>

</body>
</html>
